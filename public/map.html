<link rel="stylesheet" type="text/css" href="http://extjs.cachefly.net/ext-3.4.0/resources/css/ext-all.css" />
<link rel="stylesheet" type="text/css" href="http://extjs.cachefly.net/ext-3.4.0/examples/shared/examples.css" />

<script src='http://www.openlayers.org/dev/OpenLayers.js' type="text/javascript"></script>
<script type="text/javascript" src="http://extjs.cachefly.net/ext-3.4.0/adapter/ext/ext-base.js"></script>
<script type="text/javascript" src="http://extjs.cachefly.net/ext-3.4.0/ext-all.js"></script>
<script type="text/javascript" src="geoext/script/GeoExt.js"></script>
<script src="extjs/builds/ext-all-sandbox.js" type="text/javascript"></script>
<script src='https://maps.googleapis.com/maps/api/js?key=AIzaSyD4nINMTYXMM9Mkb35C8Jy_mZ--grp9B1Y&sensor=false'></script>

<script>

var app, mapPanel, gridPanel, items = [], controls = [];

Ext.onReady(function() {

	var options = {
		maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
		numZoomLevels:18,
		maxResolution:156543.0339,
		units:'m',
		projection: "EPSG:900913",
		displayProjection: new OpenLayers.Projection("EPSG:4326"),
		controls: [
			new OpenLayers.Control.Navigation(),
			new OpenLayers.Control.PanZoomBar(),
			new OpenLayers.Control.LayerSwitcher({'ascending':true}),
			new OpenLayers.Control.Permalink(),
			new OpenLayers.Control.ScaleLine(),
			new OpenLayers.Control.Permalink('permalink'),
			new OpenLayers.Control.MousePosition(),
			//new OpenLayers.Control.OverviewMap(),
			new OpenLayers.Control.KeyboardDefaults()
		]
	};

	map = new OpenLayers.Map('map', options);
	
	// Open Street Map layer
	var osmLayer = new OpenLayers.Layer.OSM("OpenStreetMap");

	// Google Streets layer
	var gmap = new OpenLayers.Layer.Google(
		"Google Streets",
		{'sphericalMercator': true,
		 'maxExtent': new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34)
		}
	);

	// Google Physical layer
	var gphy = new OpenLayers.Layer.Google(
		"Google Physical",
		{type: google.maps.MapTypeId.TERRAIN}
		// used to be {type: G_PHYSICAL_MAP}
	);

	// Google Hybrid layer
	var ghyb = new OpenLayers.Layer.Google(
		"Google Hybrid",
		{type: google.maps.MapTypeId.HYBRID, numZoomLevels: 20}
		// used to be {type: G_HYBRID_MAP, numZoomLevels: 20}
	);

	// Google Sattelite layer
	var gsat = new OpenLayers.Layer.Google(
		"Google Satellite",
		{type: google.maps.MapTypeId.SATELLITE, numZoomLevels: 22}
		// used to be {type: G_SATELLITE_MAP, numZoomLevels: 22}
	);	

	// US States and Counties overlay
	var state = new OpenLayers.Layer.ArcGIS93Rest("US States & Counties", "http://sampleserver1.arcgisonline.com/ArcGIS/rest/***REMOVED***s/Specialty/ESRI_StateCityHighway_USA/MapServer/export", {
		layers: "show:2",
		transparent:true,
		isBaseLayer:false
	});
	state.setVisibility(false);

	// US Highways overlay
	var highways = new OpenLayers.Layer.ArcGIS93Rest("US Highways", "http://sampleserver1.arcgisonline.com/ArcGIS/rest/***REMOVED***s/Specialty/ESRI_StateCityHighway_USA/MapServer/export", {
		layers: "show:0",
		transparent:true,
		isBaseLayer:false
	});
	highways.setVisibility(false);

	// US Rivers overlay
	var rivers = new OpenLayers.Layer.ArcGIS93Rest("US Rivers", "http://sampleserver1.arcgisonline.com/ArcGIS/rest/***REMOVED***s/Specialty/ESRI_StatesCitiesRivers_USA/MapServer/export", {
		layers: "show:1",
		transparent:true,
		isBaseLayer:false
	});
	rivers.setVisibility(false);
	
	var agsstreet = new OpenLayers.Layer.ArcGIS93Rest("ESRI Street Imagery","http://server.arcgisonline.com/ArcGIS/rest/***REMOVED***s/ESRI_StreetMap_World_2D/MapServer/export");
	agsstreet.params.FORMAT = "jpg";
	
	var agsimagery = new OpenLayers.Layer.ArcGIS93Rest("ESRI World Imagery","http://server.arcgisonline.com/ArcGIS/rest/***REMOVED***s/ESRI_Imagery_World_2D/MapServer/export");
	agsimagery.params.FORMAT = "jpg";
				
	var sageFeatures = new OpenLayers.Layer.Vector("SAGE Features", {projection: map.displayProjection,});
	
	// create feature store, binding it to the vector layer
    store = new GeoExt.data.FeatureStore({
        layer: sageFeatures,
        fields: [
            {name: 'eventtype', type: 'string'},
			{name: 'address', type: 'string'},
			{name: 'description', type: 'string'},
			{name: 'eventclear', type: 'number'},
			{name: 'eventdate', type: 'date', dateFormat: 'U'},
			{name: 'team', type: 'string'},
			{name: 'unit', type: 'string'},
			{name: 'usng', type: 'string'},
            {name: 'eventlevel', type: 'string'}
        ],
        proxy: new GeoExt.data.ProtocolProxy({
            protocol: new OpenLayers.Protocol.HTTP({
                //url: "./summits.json",
				url: "api/v1/featureMapPoints",
				format: new OpenLayers.Format.GeoJSON({
					'internalProjection': new OpenLayers.Projection("EPSG:900913"),
					'externalProjection': new OpenLayers.Projection("EPSG:4326")
				})
            })
        }),
        autoLoad: true
    });
	
	// override default epsg code
	aliasproj = new OpenLayers.Projection("EPSG:3857");
	gmap.projection = gphy.projection = ghyb.projection = gsat.projection = state.projection = highways.projection = rivers.projection = osmLayer.projection = agsstreet.projection = agsimagery.projection = sageFeatures.projection = aliasproj;

		
	//add baselayers to map
	map.addLayers([gmap, gphy, ghyb, gsat, agsstreet, agsimagery, osmLayer, state, highways, rivers, sageFeatures]);

    var lonlat = new OpenLayers.LonLat(-98.35,39.50);
    lonlat.transform(map.displayProjection, map.baseLayer.projection);
    map.setCenter(lonlat);

	//marker = new ....
	//var size = new OpenLayers.Size(25, 12);
	//var offset = new OpenLayers.Pixel(-(size.w / 2), -size.h);
	//marker.icon = new OpenLayers.Icon("marker.png", size, offset);
	////UPDATE AGAIN
	//marker.icon.size = size;
	//marker.icon.offset = offset;
	//marker.draw();

	// create select feature control
    var selectCtrl = new OpenLayers.Control.SelectFeature(sageFeatures);
	
    // define "createPopup" function
    var bogusMarkup = "Lorem ipsum dolor sit amet, consectetuer adipiscing elit.";
	
	var tpl = new Ext.XTemplate(
		'<p>Event Clear: {name}</p>',
		'<p>Address: {company}</p>',
		'<p>Date: {city}, {state}</p>',
		'<p>Type: ',
		'<p>Level: ',
		'<p>Team: ',
		'<p>Unit: ',
		'<p>Description: ',
		'<p>USNG: ',
		
		
		
		
		'</tpl></p>'
	);	
	
    function createPopup(feature) {
        popup = new GeoExt.Popup({
            title: feature.data.eventtype,
            location: feature,
            width:200,
			height:200,
            html: bogusMarkup,
            maximizable: true,
            collapsible: true
        });
        // unselect feature when the popup
        // is closed
        popup.on({
            close: function() {
                if(OpenLayers.Util.indexOf(sageFeatures.selectedFeatures,
                                           this.feature) > -1) {
                    selectCtrl.unselect(this.feature);
                }
            }
        });
        popup.show();
    }

    // create popup on "featureselected"
    sageFeatures.events.on({
        featureselected: function(e) {
            createPopup(e.feature);
			//popup.setTitle(e.feature.data.eventtype);
			console.log(e.feature.data);
        }
    });
	
	var mapPanel = new GeoExt.MapPanel({
		title: 'SAGE Mapping Tool',
		map: map,
        zoom: 5,
		stateful: true,
		stateId: 'mappanel',
		dockedItems: [{
			xtype: 'toolbar',
			dock: 'top',
			items: [{
				text: 'Current center of the map',
				handler: function(){
					var c = GeoExt.panel.Map.guess().map.getCenter();
					Ext.Msg.alert(this.getText(), c.toString());
				}
			}]
		}]
	});

    // create grid panel configured with feature store
    gridPanel = new Ext.grid.GridPanel({
        title: "Feature Grid",
        region: "west",
        store: store,
		id:'gridPanel',
        columns: [{
            header: "Type",
            width: 175,
            dataIndex: "eventtype"
        }, {
            header: "Event Level",
            width: 100,
            dataIndex: "eventlevel"
        }, {
            header: "Address",
            width: 200,
            dataIndex: "address",
			hidden: true			
        }, {
            header: "Description",
            width: 200,
            dataIndex: "description",
			hidden: true			
        }, {
            header: "Event Clear",
            width: 200,
            dataIndex: "eventclear",
			hidden: true			
        }, {
            header: "Event Date",
            width: 200,
            dataIndex: "eventdate",
			hidden: false			
        }, {
            header: "Team",
            width: 200,
            dataIndex: "team",
			hidden: true			
        }, {
            header: "Unit",
            width: 200,
            dataIndex: "unit",
			hidden: true			
        }, {
            header: "USNG",
            width: 200,
            dataIndex: "usng",
			hidden: true			
        }],
        sm: new GeoExt.grid.FeatureSelectionModel() 
    });	
	
    new Ext.Viewport({
        layout: {
            type: 'border',
            padding: 5
        },
        defaults: {
            split: true
        },
        items: [{
            region: 'west',
            collapsible: false,
            //title: 'Starts at width 30%',
            split: true,
            width: '25%',
			splitterResize: false,
			layout: 'fit',
            //minWidth: 100,
            //minHeight: 140,
            items: [gridPanel]
        },{
            region: 'east',
            collapsible: false,
            //title: 'Starts at width 30%',
            split: true,
            width: '0%',
			splitterResize: false,
			layout: 'fit',
            //minWidth: 100,
            //minHeight: 140,
            items: []
        },{
            region: 'center',
			layout: 'fit',
			frame: false,
			border: true,
            items: [mapPanel]
        }]
    });
});


</script>